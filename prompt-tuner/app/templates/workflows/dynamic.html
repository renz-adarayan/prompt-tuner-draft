{% extends "base.html" %}

{% block title %}Dynamic Workflows - Prompt Tuner{% endblock %}

{% block head %}
<style>
    :root {
        --primary-blue: #007bff;
        --light-blue: #e3f2fd;
        --border-color: #dee2e6;
        --text-muted: #6c757d;
        --danger-red: #dc3545;
        --success-green: #28a745;
    }

    .enhanced-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }

    /* Tab Navigation */
    .tab-navigation {
        display: flex;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 2rem;
        gap: 0;
    }

    .tab-button {
        background: none;
        border: none;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 500;
        color: var(--text-muted);
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        position: relative;
    }

    .tab-button:hover {
        color: var(--primary-blue);
        background-color: #f8f9fa;
    }

    .tab-button.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
        background-color: white;
    }

    /* Tab Content */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Card Styles */
    .enhanced-card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: box-shadow 0.2s ease;
    }

    .enhanced-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Form Elements */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .form-input::placeholder {
        color: #adb5bd;
    }


    /* Generic Option Selection Cards */
    .option-selection {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .option-card {
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        background: white;
    }

    .option-card:hover {
        border-color: var(--primary-blue);
        background-color: var(--light-blue);
    }

    .option-card.selected {
        border-color: var(--primary-blue);
        background-color: var(--light-blue);
    }

    .option-icon {
        font-size: 1.5rem;
        width: 2rem;
        text-align: center;
    }

    .option-name {
        font-weight: 500;
        color: #333;
    }

    /* Buttons */
    .btn-primary {
        background-color: var(--primary-blue);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    /* Plus Icon Button */
    .btn-plus {
        background-color: var(--primary-blue);
        border: none;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-left: 0.5rem;
        line-height: 1;
    }

    .btn-plus:hover {
        background-color: #0056b3;
        transform: scale(1.1);
    }

    /* Section Header with Plus */
    .section-header-with-plus {
        display: flex;
        align-items: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
    }

    .btn-danger {
        background-color: var(--danger-red);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn-secondary {
        background-color: var(--text-muted);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .btn-secondary:hover {
        background-color: #545b62;
    }

    /* Section Headers */
    .section-header {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--border-color);
    }

    .subsection-header {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
    }

    /* Customer Review Section */
    .review-section {
        background-color: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 1.5rem;
        margin-top: 1rem;
    }

    .rating-input {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .rating-label {
        font-weight: 500;
        color: #333;
        min-width: 100px;
    }

    .rating-number {
        width: 80px;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        text-align: center;
    }

    .comment-textarea {
        width: 100%;
        min-height: 100px;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        resize: vertical;
        font-family: inherit;
    }

    /* Action Buttons */
    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        justify-content: flex-start;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .enhanced-container {
            padding: 1rem;
        }
        
        .tab-button {
            padding: 0.75rem 1rem;
            font-size: 1rem;
        }
        
        .action-buttons {
            flex-direction: column;
        }
        
        .action-buttons button {
            width: 100%;
        }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--text-muted);
    }

    .empty-state-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    /* Form Grid */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Date Input Styling */
    .date-input {
        position: relative;
    }

    .date-input input[type="date"] {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
    }

    /* Select Styling */
    .select-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        background-color: white;
        cursor: pointer;
    }

    .select-input:focus {
        outline: none;
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    /* Schema Selector Tiles */
    .schema-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }

    .schema-tile {
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    .schema-tile:hover {
        border-color: var(--primary-blue);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.15);
        transform: translateY(-2px);
    }

    .schema-tile.active {
        border-color: var(--primary-blue);
        background: linear-gradient(135deg, var(--light-blue) 0%, white 100%);
        box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
    }

    .schema-tile.active::before {
        content: '✓';
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: var(--primary-blue);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .schema-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        display: block;
    }

    .schema-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }

    .schema-description {
        color: var(--text-muted);
        font-size: 0.9rem;
        line-height: 1.4;
    }

    @media (max-width: 768px) {
        .schema-selector {
            grid-template-columns: 1fr;
        }
        
        .schema-tile {
            padding: 1.5rem;
        }
        
        .schema-icon {
            font-size: 2.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="enhanced-container">
    <div class="page-header" style="margin-bottom: 2rem;">
        <h1 style="font-size: 2rem; font-weight: 600; color: #333; margin-bottom: 0.5rem;">
            Dynamic Workflows
        </h1>
        <p style="color: var(--text-muted); margin: 0;">
            Schema-driven workflow processing with dynamic UI generation
        </p>
    </div>

    <div class="section-header">Schema Selection</div>
    <div class="schema-selector" id="schema-selector">
        </div>

    <div class="section-header" id="form-header" style="display: none;">Dynamic Form</div>
    
    <div id="dynamic-form-container">
        </div>
    
    <div class="action-buttons" id="form-actions" style="display: none;">
        <button class="btn-primary" id="add-entity-btn" onclick="addEntity()">Add Entity</button>
    </div>

    <div style="margin-top: 3rem; padding-top: 2rem; border-top: 2px solid var(--border-color);">
        <div class="action-buttons">
            <button class="btn-primary" onclick="processData()" style="font-size: 1.1rem; padding: 1rem 2rem;">
                🚀 Process All Data
            </button>
            <button class="btn-secondary" onclick="exportData()">
                📤 Export Data
            </button>
            <button class="btn-secondary" onclick="resetAll()">
                🔄 Reset All
            </button>
        </div>
    </div>

    <div id="results-section" style="margin-top: 2rem; display: none;">
        <div class="section-header">Processing Results</div>
        <div id="results-container" class="enhanced-card">
            </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global data storage
let formData = {};
let currentSchema = null;
let schemaCache = {};
let availableWorkflows = [];
let fieldCache = {}; // Store field definitions for array items

// API Configuration
const API_BASE_URL = 'http://localhost:8000/api/v1/custom-workflows';

// Fetch available workflows on page load
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Dynamic Workflows System loaded');
    await fetchAvailableWorkflows();
    await generateSchemaTiles();
    console.log('Schema tiles generated successfully');
});

async function fetchAvailableWorkflows() {
    try {
        console.log('[fetchAvailableWorkflows] Fetching available workflows from API...');
        const response = await fetch(`${API_BASE_URL}/list`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        availableWorkflows = data.custom_workflows || [];
        console.log('[fetchAvailableWorkflows] availableWorkflows:', availableWorkflows);
    } catch (error) {
        console.error('[fetchAvailableWorkflows] Failed to fetch available workflows:', error);
        availableWorkflows = []; // Default to an empty array if the fetch fails
    }
}

// Utility function to clean up display names
function cleanDisplayName(name) {
    if (!name) return '';
    let cleaned = name.replace(/^RootModel_/i, '');
    cleaned = cleaned.replace(/_/g, ' ');
    cleaned = cleaned.replace(/\b\w/g, l => l.toUpperCase());
    return cleaned;
}

// Get user-friendly schema title
function getSchemaTitle(schema, workflowName) {
    if (schema.title && schema.title !== 'RootModel') {
        return schema.title;
    }
    return workflowName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

// API Functions
async function fetchSchema(workflowName) {
    if (schemaCache[workflowName]) {
        return schemaCache[workflowName];
    }
    try {
        const response = await fetch(`${API_BASE_URL}/schema/${workflowName}/`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const schema = await response.json();
        schemaCache[workflowName] = schema;
        return schema;
    } catch (error) {
        console.error(`Failed to fetch schema for ${workflowName}:`, error);
        throw new Error(`Schema fetch failed: ${workflowName}`);
    }
}

// Dynamic Schema Tile Generation
async function generateSchemaTiles() {
    const selectorContainer = document.getElementById('schema-selector');
    selectorContainer.innerHTML = '<div class="loading">Loading schemas...</div>';

    let tilesHtml = '';
    if (availableWorkflows.length === 0) {
        selectorContainer.innerHTML = '<div class="empty-state">No workflows found.</div>';
        return;
    }

    for (const workflowName of availableWorkflows) {
        try {
            const schema = await fetchSchema(workflowName);
            const rootModel = schema.schemas.RootModel;
            const schemaTitle = getSchemaTitle(rootModel, workflowName);
            tilesHtml += `
                <div class="schema-tile" id="${workflowName}-schema" onclick="selectSchema('${workflowName}', this)">
                    <div class="schema-icon">⚙️</div>
                    <div class="schema-title">${schemaTitle}</div>
                    <div class="schema-description">${rootModel.description || `Dynamic ${workflowName.replace(/_/g, ' ')} workflow`}</div>
                </div>
            `;
        } catch (error) {
            console.error(`Failed to load schema for ${workflowName}:`, error);
            tilesHtml += `
                <div class="schema-tile disabled">
                    <div class="schema-icon">❌</div>
                    <div class="schema-title">${workflowName.replace(/_/g, ' ')}</div>
                    <div class="schema-description">Failed to load schema</div>
                </div>
            `;
        }
    }
    selectorContainer.innerHTML = tilesHtml;
}

// Schema Selection Function
async function selectSchema(schemaName, element) {
    document.querySelectorAll('.schema-tile').forEach(tile => tile.classList.remove('active'));
    element.classList.add('active');
    currentSchema = schemaName;
    await loadSchemaForm(schemaName);
    resetFormData();
}

async function loadSchemaForm(schemaName) {
    try {
        const schema = await fetchSchema(schemaName);
        const rootModel = schema.schemas.RootModel;
        
        document.getElementById('form-header').style.display = 'block';
        document.getElementById('form-actions').style.display = 'block';
        
        const formTitle = getSchemaTitle(rootModel, schemaName);
        document.getElementById('form-header').textContent = formTitle;
        
        const formHtml = generateFormFromSchema(rootModel, schema.schemas);
        document.getElementById('dynamic-form-container').innerHTML = formHtml;
        
        initializeFormData(rootModel);
        await autoAddFirstArrayItems(rootModel);
    } catch (error) {
        console.error('Failed to load schema form:', error);
        document.getElementById('dynamic-form-container').innerHTML = `
            <div class="enhanced-card">
                <div class="empty-state">
                    <div class="empty-state-icon">❌</div>
                    <p>Failed to load schema form</p>
                </div>
            </div>
        `;
    }
}

async function autoAddFirstArrayItems(rootModel) {
    if (!rootModel.properties) return;
    for (const [fieldName, field] of Object.entries(rootModel.properties)) {
        if (field.type === 'array' && field.ui_component === 'array') {
            setTimeout(async () => {
                await addArrayItemByName(fieldName);
            }, 100);
        }
    }
}

function generateFormFromSchema(model, allSchemas) {
    if (!model.properties) return '';
    let formHtml = '';
    const displayOrder = model.ui_metadata?.display_order || Object.keys(model.properties);
    for (const fieldName of displayOrder) {
        const field = model.properties[fieldName];
        if (field) {
            formHtml += generateFieldHtml(fieldName, field, allSchemas);
        }
    }
    return formHtml;
}

function generateFieldHtml(fieldName, field, allSchemas) {
    const displayName = field.display_name || field.title || fieldName;
    const fieldId = `field-${fieldName}`;
    
    switch (field.ui_component) {
        case 'text_input':
            return `
                <div class="form-group">
                    <label class="form-label">${displayName}</label>
                    <input type="text" class="form-input" id="${fieldId}" 
                           placeholder="Enter ${displayName.toLowerCase()}"
                           onchange="updateFormData('${fieldName}', this.value)">
                </div>
            `;
        case 'number_input':
            const numConf = field.number_config || {};
            return `
                <div class="form-group">
                    <label class="form-label">${displayName}</label>
                    <input type="number" class="form-input" id="${fieldId}"
                           min="${numConf.min || ''}" max="${numConf.max || ''}" step="${numConf.step || 1}"
                           placeholder="Enter ${displayName.toLowerCase()}"
                           onchange="updateFormData('${fieldName}', parseFloat(this.value))">
                </div>
            `;
        case 'array':
            return generateArrayField(fieldName, field, allSchemas);
        case 'union_select':
            return generateUnionSelectField(fieldName, field, allSchemas);
        default:
            return `
                <div class="form-group">
                    <label class="form-label">${displayName}</label>
                    <input type="text" class="form-input" id="${fieldId}"
                           placeholder="Enter ${displayName.toLowerCase()}"
                           onchange="updateFormData('${fieldName}', this.value)">
                </div>
            `;
    }
}

function generateArrayField(fieldName, field, allSchemas) {
    const displayName = field.display_name || field.title || fieldName;
    fieldCache[`${currentSchema}_${fieldName}`] = field;
    return `
        <div class="enhanced-card">
            <div class="section-header-with-plus">
                <span>${displayName}</span>
                <button class="btn-plus" onclick="addArrayItemByName('${fieldName}')" title="Add ${displayName}">+</button>
            </div>
            <div id="array-${fieldName}" class="array-container"></div>
        </div>
    `;
}

function generateUnionSelectField(fieldName, field, allSchemas) {
    const displayName = field.display_name || field.title || fieldName;
    const unionOptions = field.union_options || [];
    let optionsHtml = unionOptions.map(option => `
        <div class="option-card" onclick="selectUnionOption('${fieldName}', '${option.value}', this)">
            <span class="option-icon">${getUnionIcon(option.label)}</span>
            <span class="option-name">${option.label}</span>
        </div>
    `).join('');

    return `
        <div class="form-group">
            <label class="form-label">${displayName}</label>
            <div class="option-selection" id="union-${fieldName}">${optionsHtml}</div>
        </div>
    `;
}

function getUnionIcon(label) {
    // Returns a generic icon for any label
    return '🔧';
}

function selectUnionOption(fieldName, value, element) {
    element.parentNode.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
    element.classList.add('selected');
    updateFormData(fieldName, value);
}

// Wrapper function that uses cached field data
async function addArrayItemByName(fieldName) {
    const fieldKey = `${currentSchema}_${fieldName}`;
    const field = fieldCache[fieldKey];
    if (!field) {
        console.error(`Field definition not found in cache for: ${fieldKey}`);
        alert('Field definition not found. Please try refreshing the page.');
        return;
    }
    return await addArrayItem(fieldName, field);
}

async function addArrayItem(fieldName, field) {
    try {
        const schema = await fetchSchema(currentSchema);
        const arrayContainer = document.getElementById(`array-${fieldName}`);
        if (!arrayContainer) return;

        if (!formData[currentSchema]) formData[currentSchema] = {};
        if (!formData[currentSchema][fieldName]) formData[currentSchema][fieldName] = [];
        
        const itemIndex = formData[currentSchema][fieldName].length;
        const ref = field.items?.$ref;
        if (!ref) {
            console.error('Array item schema reference ($ref) not found.');
            return;
        }

        const schemaName = ref.split('/').pop();
        const itemSchema = schema.schemas[schemaName] || schema.schemas.RootModel?.definitions?.[schemaName];
        if (!itemSchema) {
            console.error(`Could not find schema for array item: ${ref}`);
            return;
        }
        
        const itemHtml = generateArrayItemHtml(fieldName, itemIndex, itemSchema, schema.schemas);
        arrayContainer.insertAdjacentHTML('beforeend', itemHtml);
        
        const itemData = { ...(itemSchema.default_values || {}) };
        formData[currentSchema][fieldName].push(itemData);
        console.log(`Added array item for ${fieldName}:`, itemData);
    } catch (error) {
        console.error('Failed to add array item:', error);
    }
}

function generateArrayItemHtml(fieldName, itemIndex, itemSchema, allSchemas) {
    const itemId = `${fieldName}-item-${itemIndex}`;
    let displayName = cleanDisplayName(itemSchema.title || itemSchema.model_name) || `Item ${itemIndex + 1}`;
    
    let fieldsHtml = '';
    if (itemSchema.properties) {
        const displayOrder = itemSchema.ui_metadata?.display_order || Object.keys(itemSchema.properties);
        for (const propName of displayOrder) {
            const prop = itemSchema.properties[propName];
            if (prop) {
                fieldsHtml += generateArrayItemFieldHtml(fieldName, itemIndex, propName, prop, allSchemas);
            }
        }
    }
    
    return `
        <div class="enhanced-card" id="${itemId}" style="margin-left: 1rem; border-left: 3px solid var(--primary-blue);">
            <div class="subsection-header">${displayName}</div>
            ${fieldsHtml}
            <div class="action-buttons">
                <button class="btn-danger" onclick="removeArrayItem('${fieldName}', ${itemIndex})">Remove ${displayName}</button>
            </div>
        </div>
    `;
}

function generateArrayItemFieldHtml(fieldName, itemIndex, propName, prop, allSchemas) {
    const displayName = prop.display_name || prop.title || propName;
    const fieldId = `${fieldName}-${itemIndex}-${propName}`;
    
    if (prop.anyOf || prop.union_options || prop.ui_component === 'union_select') {
        return generateArrayItemUnionField(fieldName, itemIndex, propName, prop, allSchemas);
    }
    if (prop.type === 'array' || prop.ui_component === 'array') {
        return generateNestedArrayField(fieldName, itemIndex, propName, prop, allSchemas);
    }

    const onchange = `onchange="updateArrayItemData('${fieldName}', ${itemIndex}, '${propName}', this.value)"`;
    const onchangeFloat = `onchange="updateArrayItemData('${fieldName}', ${itemIndex}, '${propName}', parseFloat(this.value))"`;

    switch (prop.type) {
        case 'number':
        case 'integer':
             return `
                <div class="form-group">
                    <label class="form-label">${displayName}</label>
                    <input type="number" class="form-input" id="${fieldId}" placeholder="Enter ${displayName.toLowerCase()}" ${onchangeFloat}>
                </div>`;
        default:
            return `
                <div class="form-group">
                    <label class="form-label">${displayName}</label>
                    <input type="text" class="form-input" id="${fieldId}" placeholder="Enter ${displayName.toLowerCase()}" ${onchange}>
                </div>`;
    }
}

function generateNestedArrayField(parentFieldName, parentIndex, fieldName, field, allSchemas) {
    const displayName = field.display_name || field.title || fieldName;
    const nestedFieldId = `${parentFieldName}-${parentIndex}-${fieldName}`;
    fieldCache[`${currentSchema}_${nestedFieldId}`] = field;
    return `
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <div class="section-header-with-plus">
                <span>${displayName}</span>
                <button class="btn-plus" onclick="addNestedArrayItem('${nestedFieldId}')" title="Add ${displayName}">+</button>
            </div>
            <div id="array-${nestedFieldId}" class="array-container"></div>
        </div>
    `;
}

async function addNestedArrayItem(nestedFieldId) {
    const fieldKey = `${currentSchema}_${nestedFieldId}`;
    const field = fieldCache[fieldKey];
    if (!field) {
        console.error(`Nested field definition not found in cache for: ${fieldKey}`);
        return;
    }
    return await addArrayItem(nestedFieldId, field);
}

function generateArrayItemUnionField(fieldName, itemIndex, propName, prop, allSchemas) {
    const displayName = prop.display_name || prop.title || propName;
    let unionOptions = prop.union_options || [];
    
    if (unionOptions.length === 0 && prop.anyOf) {
        unionOptions = prop.anyOf.map(option => {
            if (!option.$ref) return null;
            const schemaName = option.$ref.split('/').pop();
            return {
                value: schemaName.toLowerCase(),
                label: cleanDisplayName(schemaName),
                schema_ref: option.$ref,
            };
        }).filter(Boolean);
    }
    
    let optionsHtml = unionOptions.map(option => `
        <div class="option-card" onclick="selectArrayItemUnionOption('${fieldName}', ${itemIndex}, '${propName}', '${option.value}', this)">
            <span class="option-icon">${getUnionIcon(option.label)}</span>
            <span class="option-name">${option.label}</span>
        </div>
    `).join('');

    return `
        <div class="form-group">
            <label class="form-label">${displayName}</label>
            <div class="option-selection">${optionsHtml}</div>
        </div>
    `;
}

function updateArrayItemData(fieldName, itemIndex, propName, value) {
    if (!formData[currentSchema]?.[fieldName]?.[itemIndex]) {
        formData[currentSchema][fieldName][itemIndex] = {};
    }
    formData[currentSchema][fieldName][itemIndex][propName] = value;
    console.log(`Updated array item data:`, formData[currentSchema][fieldName][itemIndex]);
}

function selectArrayItemUnionOption(fieldName, itemIndex, propName, value, element) {
    element.parentNode.querySelectorAll('.option-card').forEach(card => card.classList.remove('selected'));
    element.classList.add('selected');
    updateArrayItemData(fieldName, itemIndex, propName, value);
}

function removeArrayItem(fieldName, itemIndex) {
    const itemId = `${fieldName}-item-${itemIndex}`;
    document.getElementById(itemId)?.remove();
    formData[currentSchema]?.[fieldName]?.splice(itemIndex, 1);
    console.log(`Removed array item ${itemIndex} from ${fieldName}`);
}

function updateFormData(fieldName, value) {
    if (!formData[currentSchema]) formData[currentSchema] = {};
    formData[currentSchema][fieldName] = value;
    console.log('Updated form data:', formData);
}

function initializeFormData(model) {
    if (!formData[currentSchema]) formData[currentSchema] = {};
    if (model.default_values) {
        Object.assign(formData[currentSchema], model.default_values);
    }
}

function resetFormData() {
    if (currentSchema) formData[currentSchema] = {};
    document.querySelectorAll('.form-input').forEach(input => input.value = '');
    document.querySelectorAll('.option-card.selected').forEach(card => card.classList.remove('selected'));
}

async function addEntity() {
    if (!currentSchema) {
        alert('Please select a schema first');
        return;
    }
    try {
        const schema = await fetchSchema(currentSchema);
        const rootModel = schema.schemas.RootModel;
        const arrayField = findMainArrayField(rootModel);
        if (arrayField) {
            addArrayItem(arrayField.name, arrayField.field);
        } else {
            alert('No main entity array found in schema');
        }
    } catch (error) {
        console.error('Failed to add entity:', error);
    }
}

function findMainArrayField(model) {
    if (!model.properties) return null;
    for (const [fieldName, field] of Object.entries(model.properties)) {
        if (field.type === 'array' && field.ui_component === 'array') {
            return { name: fieldName, field: field };
        }
    }
    return null;
}

function processData() {
    if (!currentSchema || !formData[currentSchema]) {
        alert('Please select a schema and enter some data first');
        return;
    }
    
    const resultsSection = document.getElementById('results-section');
    resultsSection.style.display = 'block';
    const results = generateSchemaResults();
    displayResults(results);
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}

function generateSchemaResults() {
    const data = formData[currentSchema] || {};
    const dataKeys = Object.keys(data);
    return {
        summary: {
            schema: currentSchema,
            fieldsCompleted: dataKeys.length,
            dataEntries: JSON.stringify(data, null, 2)
        },
        insights: [
            `Using schema: <strong>${currentSchema}</strong>`,
            `Completed <strong>${dataKeys.length}</strong> top-level form fields.`,
            'Data structure follows the selected API-driven schema format.',
            'Form data is ready for processing or export.'
        ]
    };
}

function displayResults(results) {
    const container = document.getElementById('results-container');
    const dataStr = results.summary.dataEntries;
    const html = `
        <div style="margin-bottom: 2rem;">
            <h4 style="color: #333; margin-bottom: 1rem;">📊 Processing Summary</h4>
            <ul style="list-style: none; padding: 0;">
                ${results.insights.map(insight => `
                    <li style="padding: 0.5rem 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: var(--primary-blue); margin-right: 0.5rem;">•</span>
                        ${insight}
                    </li>
                `).join('')}
            </ul>
        </div>
        <div>
            <h4 style="color: #333; margin-bottom: 1rem;">📋 Submitted Data (JSON)</h4>
            <pre style="background-color: #f8f9fa; padding: 1rem; border-radius: 6px; border: 1px solid var(--border-color); white-space: pre-wrap; word-wrap: break-word;"><code>${dataStr}</code></pre>
        </div>
    `;
    container.innerHTML = html;
}

function exportData() {
    if (!currentSchema || !formData[currentSchema]) {
        alert('No data to export. Please fill out the form first.');
        return;
    }
    const dataToExport = {
        timestamp: new Date().toISOString(),
        workflow_name: currentSchema,
        form_data: formData[currentSchema]
    };
    
    const dataStr = JSON.stringify(dataToExport, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `${currentSchema}-data-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}

function resetAll(showConfirmation = true) {
    if (!showConfirmation || confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
        formData = {};
        currentSchema = null;
        
        document.getElementById('dynamic-form-container').innerHTML = '';
        document.getElementById('form-header').style.display = 'none';
        document.getElementById('form-actions').style.display = 'none';
        
        document.querySelectorAll('.schema-tile').forEach(tile => tile.classList.remove('active'));
        document.getElementById('results-section').style.display = 'none';
    }
}
</script>
{% endblock %}